# Auto Face-Aware Image Cropper

正方形（1:1）の画像から顔を検出し、顔の位置を中心として16:9のアスペクト比に自動クロップするツールです。写真の三分割法を活用して、人物の顔や目の位置を最適な構図に配置します。

<div align="center">
  <img src="doc_images/app_img.png" alt="アプリケーション画面" width="600"/><br>
  <em>アプリケーションの画面</em>
</div>

<br>

<div align="center">
  <img src="doc_images/crop_img.jpg" alt="クロップ結果のサンプル" width="600"/><br>
  <em>クロップ結果のサンプル</em>
</div>

## 機能概要

- 1:1の正方形画像から人物の顔を自動検出
- 検出した顔の位置を中心として16:9のアスペクト比に自動クロップ
- **三分割法（Rule of Thirds）に基づく美しい構図の自動調整**
- 目の位置を上部1/3のラインに、顔の中心を左右1/3のラインに合わせて配置
- シンプルなGUIインターフェイスで簡単操作
- 元画像とクロップ後の画像をリアルタイムでプレビュー
- クロップした画像を任意の場所に保存可能
- **MediaPipeの高性能な顔検出機能**で様々な顔のパターンに対応
- 顔認識結果を**視覚的に確認できる矩形表示機能**

## 環境構築

### 必要条件

- Python 3.8以上
- Windows、macOS、またはLinux環境

### インストール手順

1. リポジトリをクローン

```
git clone https://github.com/yourusername/auto-image-crop.git
cd auto-image-crop
```

2. 仮想環境の作成とアクティブ化

```
# Windows
python -m venv venv
.\venv\Scripts\activate

# macOS/Linux
python -m venv venv
source venv/bin/activate
```

3. 必要なライブラリのインストール

```
pip install -r requirements.txt
```

## 使用方法

### 簡易起動スクリプト

以下の簡易起動スクリプトを使えば、仮想環境のアクティベーションからアプリケーションの起動までを一度に行うことができます：

- **Windows**: `run_app.bat` をダブルクリック
- **Linux/macOS**: ターミナルで `./run_app.sh` を実行（初回実行時は `chmod +x run_app.sh` で実行権限を付与してください）

これらのスクリプトは自動的に仮想環境をアクティベートし、アプリケーションを起動します。環境がまだ構築されていない場合は、セットアップ手順を表示します。

### 手動起動

1. アプリケーションの起動

```
python run.py
```

1. 「画像を読み込む」ボタンをクリックして、クロップしたい画像を選択
2. 「顔認識してクロップ」ボタンをクリックして、顔検出と自動クロップを実行
3. 「クロップ画像を保存」ボタンをクリックして、クロップした画像を保存

## 顔認識の技術

このアプリケーションでは、Googleが開発した最新のMediaPipe顔検出技術を採用しています：

### MediaPipeの高性能顔検出

- **ディープラーニングベースの先進的な顔検出**：
  - 高精度な顔検出と位置特定
  - 様々な顔の向きや表情、照明条件下でも安定した検出
  - 横顔や部分的に隠れた顔に対しても優れた認識精度
  - 異なる人種や年齢、メガネ着用などの多様なケースに対応
  - 軽量かつ高速な処理のためモバイルデバイスでも実用的な性能

### 顔検出の判定条件とスコア算出式

複数の顔が検出された場合、以下の3つの要素を考慮して最適な顔を選択します：

1. **顔のサイズ評価 (40%)**：
   - 顔の面積（幅×高さ）が大きいほど高スコア
   - 計算式： `size_score = (顔の面積) / (検出された最大の顔の面積)`
   - 大きい顔ほど主要な被写体である可能性が高いという考えに基づく

2. **中央度評価 (40%)**：
   - 顔が画像の中心に近いほど高スコア
   - 計算式： `center_score = 1.0 - (中心からの距離) / (検出された最も遠い顔の距離)`
   - 中央に位置する顔ほど主要な被写体である可能性が高いという考えに基づく

3. **鮮明度評価 (20%)**：
   - 顔がより鮮明であるほど高スコア
   - 計算式： `sharpness_score = (顔領域の鮮明度) / (検出された最も鮮明な顔の鮮明度)`
   - 鮮明度はラプラシアンフィルタを使用して顔領域のエッジの強さを測定

**最終スコア算出式**：
```
total_score = (0.4 × size_score) + (0.4 × center_score) + (0.2 × sharpness_score)
```

この重み付けスコアが最も高い顔を選択し、クロップの基準として使用します。これにより、一般的な写真で最も重要な被写体となる顔を優先的に選択できます。

### 顔検出処理の最適化

- 顔領域を10%拡張して認識精度を向上
- 複数の顔が検出された場合は最も大きい顔を優先
- 顔の中心位置と大きさを正確に特定

### 視覚的フィードバック機能

- **顔の矩形表示**：
  - クロップの基準となった主要な顔：太い赤色の矩形（線幅2）で表示
  - クロップ後の画像で再検出された顔：細い線（線幅1）で表示
  - 顔の中心点：小さな赤い円で表示
  - 表示用画像のみに矩形を描画し、保存画像には描画しない

- **三分割グリッドの表示**：
  - 緑色の線でクロップ後の三分割ラインを表示
  - 顔の配置がどの三分割ラインに合わせられているかを視覚的に確認可能

## 三分割法による構図の最適化

このアプリケーションは写真撮影における基本テクニックである「三分割法」（Rule of Thirds）を活用して、より美しい構図のクロップを実現します：

- 画像を縦横それぞれ3等分し、9つの長方形と4つの交点を作るグリッドを想定
- 人物の目の位置を上部1/3のラインに自動的に合わせて配置
- 顔の中心を最も近い縦方向の1/3ライン（左または右）に合わせて配置
- 完全中央ではなく少しずらすことで、視覚的に安定感と動きのある構図を実現

このようなクロップにより、写真として見たときの視覚的な魅力が高まり、より自然で洗練された印象を与えます。

### 三分割法の自動適用プロセス

1. 顔検出により顔の位置と大きさを特定
2. 顔の形状から目の位置を推定し、縦方向の基準点を決定
3. この基準点が画像上部の1/3ラインに来るようにクロップ位置を計算
4. 顔の中心が左右どちらの1/3ラインに近いかを判定
5. 近い方の1/3ラインに顔の中心が来るようにクロップ位置を水平方向に調整

## 制約事項

- 入力画像は正方形（1:1）に近いアスペクト比であることが望ましい
- 非常に暗い画像や極端にぼやけた画像では検出精度が低下する場合があります
- MediaPipeの初期化時に情報メッセージが表示されることがありますが、動作に影響はありません

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルを参照してください。
