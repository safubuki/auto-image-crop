# Auto Face-Aware Image Cropper

正方形（1:1）の画像から顔を検出し、顔の位置を中心として16:9のアスペクト比に自動クロップするツールです。写真の三分割法を活用して、人物の顔や目の位置を最適な構図に配置します。

## 機能概要

- 1:1の正方形画像から人物の顔を自動検出
- 検出した顔の位置を中心として16:9のアスペクト比に自動クロップ
- **三分割法（Rule of Thirds）に基づく美しい構図の自動調整**
- 目の位置を上部1/3のラインに、顔の中心を左右1/3のラインに合わせて配置
- シンプルなGUIインターフェイスで簡単操作
- 元画像とクロップ後の画像をリアルタイムでプレビュー
- クロップした画像を任意の場所に保存可能
- **多様な顔検出機能**で一般的な顔からメガネ着用時や特殊なケースまで対応
- 顔認識結果を**視覚的に確認できる矩形表示機能**

## 環境構築

### 必要条件

- Python 3.8以上
- Windows、macOS、またはLinux環境

### インストール手順

1. リポジトリをクローン

```
git clone https://github.com/yourusername/auto-image-crop.git
cd auto-image-crop
```

2. 仮想環境の作成とアクティブ化

```
# Windows
python -m venv venv
.\venv\Scripts\activate

# macOS/Linux
python -m venv venv
source venv/bin/activate
```

3. 必要なライブラリのインストール

```
pip install -r requirements.txt
```

または、個別にインストールする場合：

```
pip install wheel cmake
pip install numpy pillow PyQt5 opencv-python opencv-contrib-python dlib
```

## 使用方法

1. アプリケーションの起動

```
python run.py
```
または
```
python auto_crop_gui.py
```

2. 「画像を読み込む」ボタンをクリックして、クロップしたい画像を選択
3. 「顔認識してクロップ」ボタンをクリックして、顔検出と自動クロップを実行
4. 「クロップ画像を保存」ボタンをクリックして、クロップした画像を保存

## 顔認識の判定基準

このアプリケーションでは複数の顔検出技術を組み合わせて、高精度な顔検出を実現しています：

### 複数の分類器を組み合わせた高精度検出

- **OpenCVのHaar Cascade分類器**：
  - `haarcascade_frontalface_default.xml` - 標準的な顔検出
  - `haarcascade_frontalface_alt.xml` - 代替の顔検出アルゴリズム
  - `haarcascade_frontalface_alt2.xml` - さらに異なるパターンの顔に対応
  - `haarcascade_eye.xml` - 一般的な目の検出
  - `haarcascade_eye_tree_eyeglasses.xml` - メガネ着用時の目検出に特化

- **DlibのHOGベース顔検出**：
  - Histogram of Oriented Gradients (HOG) 特徴量を用いた顔検出
  - OpenCVの検出器と比較して、より多様な顔パターンに対応
  - 特殊なケース（部分的に隠れた顔、着ぐるみなど）でも検出可能

- **検出精度向上のための画像前処理**：
  - ヒストグラム平坦化によるコントラスト強調
  - 複数のスケールファクター (1.1-1.3) を適用した多段階検出

### 検出結果の統合アルゴリズム

- 複数の検出器からの結果を統合し、重複を排除
- 顔の中心位置と大きさに基づく重複判定
- 最も確度の高い（サイズの大きい）顔を選択

### 視覚的フィードバック機能

- **顔の矩形表示**：
  - クロップの基準となった主要な顔：赤色の矩形で表示
  - その他の検出顔：灰色の矩形で表示
  - 表示用画像のみに矩形を描画し、保存画像には描画しない

- **三分割グリッドの表示**：
  - 緑色の線でクロップ後の三分割ラインを表示
  - 顔の配置がどの三分割ラインに合わせられているかを視覚的に確認可能

## 三分割法による構図の最適化

このアプリケーションは写真撮影における基本テクニックである「三分割法」（Rule of Thirds）を活用して、より美しい構図のクロップを実現します：

- 画像を縦横それぞれ3等分し、9つの長方形と4つの交点を作るグリッドを想定
- 人物の目の位置を上部1/3のラインに自動的に合わせて配置
- 顔の中心を最も近い縦方向の1/3ライン（左または右）に合わせて配置
- 完全中央ではなく少しずらすことで、視覚的に安定感と動きのある構図を実現

このようなクロップにより、写真として見たときの視覚的な魅力が高まり、より自然で洗練された印象を与えます。

### 三分割法の自動適用プロセス

1. 顔検出により顔の位置と大きさを特定
2. 目の検出（または顔の上部1/3の推定）により、縦方向の基準点を決定
3. この基準点が画像上部の1/3ラインに来るようにクロップ位置を計算
4. 顔の中心が左右どちらの1/3ラインに近いかを判定
5. 近い方の1/3ラインに顔の中心が来るようにクロップ位置を水平方向に調整

## 特殊ケースへの対応

このアプリケーションは、一般的な顔写真だけでなく、以下のような特殊なケースにも対応しています：

- **メガネをかけた顔**：専用の目検出器と画像コントラスト強調により精度を向上
- **特殊な顔パターン**：複数の検出アルゴリズムの併用により多様な顔に対応
- **目が検出できない場合**：顔の形状から目の位置を推定する代替アルゴリズムを実装
- **複数の顔がある場合**：最も大きな顔を主要な被写体として検出し、それを基準にクロップ

## 制約事項

- 入力画像は正方形（1:1）に近いアスペクト比であることが望ましい
- 非常に暗い画像や極端にぼやけた画像では検出精度が低下する場合があります
- 極端な角度（横顔など）の場合、検出が困難になることがあります

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルを参照してください。
